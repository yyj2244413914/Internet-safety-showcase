<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SecureDataFlow Dashboard</title>
  <!-- 引入外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            success: '#52C41A',
            warning: '#FAAD14',
            danger: '#FF4D4F',
            info: '#1890FF',
            dark: '#1D2129',
            'dark-2': '#4E5969',
            'light-1': '#F2F3F5',
            'light-2': '#E5E6EB',
            'light-3': '#C9CDD4'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-shadow {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }
      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      }
      .gradient-bg {
        background: linear-gradient(135deg, #165DFF 0%, #0E42D2 100%);
      }
      .pulse-animation {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
      .progress-bar {
        position: relative;
        overflow: hidden;
      }
      .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background: rgba(255, 255, 255, 0.2);
        transform: translateX(-100%);
        animation: progress 1.5s infinite;
      }
      @keyframes progress {
        100% {
          transform: translateX(100%);
        }
      }
    }
  </style>
</head>

<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-sm fixed w-full z-50 transition-all duration-300" id="header">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- 左侧Logo和标题 -->
        <div class="flex items-center">
          <div class="flex-shrink-0 flex items-center">
            <div class="w-8 h-8 rounded-md gradient-bg flex items-center justify-center">
              <i class="fa fa-shield text-white"></i>
            </div>
            <span class="ml-2 text-lg font-semibold text-dark">SecureDataFlow Dashboard</span>
          </div>
        </div>
        
        <!-- 右侧工具栏 -->
        <div class="flex items-center space-x-4">
          <!-- 通知图标 -->
          <div class="relative" id="notificationContainer">
            <button class="p-2 rounded-full hover:bg-light-1 transition-colors relative" id="notificationBtn">
              <i class="fa fa-bell-o text-dark-2"></i>
              <span class="absolute top-1 right-1 w-2 h-2 bg-danger rounded-full"></span>
            </button>
            <!-- 通知下拉面板 (默认隐藏) -->
            <div class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg border border-light-2 hidden z-50" id="notificationDropdown">
              <div class="p-3 border-b border-light-2">
                <h3 class="font-medium text-dark">通知中心</h3>
              </div>
              <div class="p-3 text-center text-dark-2 text-sm">
                通知功能待完善，点击下方链接跳转至示例页面
              </div>
              <div class="p-2 border-t border-light-2">
                <a href="nothing.html" class="block text-center text-primary text-sm hover:bg-light-1 py-1 rounded">查看全部通知</a>
              </div>
            </div>
          </div>
          
          <!-- 刷新按钮 -->
          <button class="p-2 rounded-full hover:bg-light-1 transition-colors" id="refreshBtn">
            <i class="fa fa-refresh text-dark-2"></i>
          </button>
          
          <!-- 用户信息 -->
          <div class="flex items-center" id="userMenuContainer">
            <img class="h-8 w-8 rounded-full object-cover" src="https://picsum.photos/id/1005/200/200" alt="用户头像">
            <span class="ml-2 text-sm font-medium hidden md:block">管理员 第136行 此行代码上一行是头像图片路径（记得改</span>
            <i class="fa fa-angle-down ml-1 text-dark-2 text-xs hidden md:block"></i>
            <!-- 用户下拉菜单 (默认隐藏) -->
            <div class="absolute right-4 mt-10 bg-white rounded-lg shadow-lg border border-light-2 hidden z-50 w-48" id="userDropdown">
              <a href="nothing.html" class="block px-4 py-2 text-sm text-dark hover:bg-light-1">个人资料</a>
              <div class="border-t border-light-2 my-1"></div>
              <a href="nothing.html" class="block px-4 py-2 text-sm text-danger hover:bg-light-1">退出登录</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="flex-1 pt-20 pb-10">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <!-- 页面标题 -->
      <div class="mb-8">
        <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-dark">Dashboard概览</h1>
        <p class="text-dark-2 mt-1">实时监控系统状态、任务进度和安全告警</p>
      </div>
      
      <!-- 状态指示器 -->
      <div class="flex items-center mb-6">
        <div class="flex items-center mr-6">
          <span class="w-3 h-3 bg-success rounded-full pulse-animation"></span>
          <span class="ml-2 text-sm text-dark-2">系统正常运行中</span>
        </div>
        <div class="flex items-center">
          <span class="text-sm text-dark-2">上次更新: <span id="lastUpdate">刚刚</span></span>
        </div>
      </div>
      
      <!-- 概览统计卡片 -->
      <section class="mb-8">
          <h2 class="text-lg font-semibold mb-4 text-dark">系统概览</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
              <!-- 任务总数卡片 -->
              <div class="bg-white rounded-xl p-6 card-shadow card-hover">
                  <div class="flex justify-between items-start">
                      <div>
                          <p class="text-dark-2 text-sm mb-1">任务总数</p>
                          <h3 class="text-3xl font-bold text-dark mb-2" id="totalTasks">-</h3>
                          <p class="text-dark-2 text-sm flex items-center">
                              <span>加载中...</span>
                          </p>
                      </div>
                      <div class="w-12 h-12 rounded-lg bg-primary/10 flex items-center justify-center">
                          <i class="fa fa-tasks text-primary text-xl"></i>
                      </div>
                  </div>
                  <div class="mt-4 h-10">
                      <canvas id="tasksChart"></canvas>
                  </div>
              </div>
              
              <!-- 活跃节点数卡片 -->
              <div class="bg-white rounded-xl p-6 card-shadow card-hover">
                  <div class="flex justify-between items-start">
                      <div>
                          <p class="text-dark-2 text-sm mb-1">活跃节点数</p>
                          <h3 class="text-3xl font-bold text-dark mb-2" id="activeNodes">-</h3>
                          <p class="text-dark-2 text-sm flex items-center">
                              <span>加载中...</span>
                          </p>
                      </div>
                      <div class="w-12 h-12 rounded-lg bg-secondary/10 flex items-center justify-center">
                          <i class="fa fa-server text-secondary text-xl"></i>
                      </div>
                  </div>
                  <div class="mt-4 h-10">
                      <canvas id="nodesChart"></canvas>
                  </div>
              </div>
              
              <!-- 数据流量卡片 -->
              <div class="bg-white rounded-xl p-6 card-shadow card-hover">
                  <div class="flex justify-between items-start">
                      <div>
                          <p class="text-dark-2 text-sm mb-1">数据流量</p>
                          <h3 class="text-3xl font-bold text-dark mb-2" id="dataTraffic">-</h3>
                          <p class="text-dark-2 text-sm flex items-center">
                              <span>加载中...</span>
                          </p>
                      </div>
                      <div class="w-12 h-12 rounded-lg bg-info/10 flex items-center justify-center">
                          <i class="fa fa-exchange text-info text-xl"></i>
                      </div>
                  </div>
                  <div class="mt-4 h-10">
                      <canvas id="trafficChart"></canvas>
                  </div>
              </div>
              
              <!-- 平均延迟卡片 -->
              <div class="bg-white rounded-xl p-6 card-shadow card-hover">
                  <div class="flex justify-between items-start">
                      <div>
                          <p class="text-dark-2 text-sm mb-1">平均延迟</p>
                          <h3 class="text-3xl font-bold text-dark mb-2" id="avgLatency">-</h3>
                          <p class="text-dark-2 text-sm flex items-center">
                              <span>加载中...</span>
                          </p>
                      </div>
                      <div class="w-12 h-12 rounded-lg bg-warning/10 flex items-center justify-center">
                          <i class="fa fa-clock-o text-warning text-xl"></i>
                      </div>
                  </div>
                  <div class="mt-4 h-10">
                      <canvas id="latencyChart"></canvas>
                  </div>
              </div>
          </div>
      </section>
      
      <!-- 图表和最近任务区域 -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
          <!-- 系统状态图表 -->
          <div class="lg:col-span-2 bg-white rounded-xl p-6 card-shadow">
              <div class="flex justify-between items-center mb-6">
                  <h2 class="text-lg font-semibold text-dark">系统性能趋势</h2>
                  <div class="flex space-x-2" id="periodSelector">
                      <button class="px-3 py-1 text-xs rounded-md bg-primary/10 text-primary period-btn" data-period="day">今日</button>
                      <button class="px-3 py-1 text-xs rounded-md hover:bg-light-1 text-dark-2 period-btn" data-period="week">本周</button>
                      <button class="px-3 py-1 text-xs rounded-md hover:bg-light-1 text-dark-2 period-btn" data-period="month">本月</button>
                  </div>
              </div>
              <div class="h-80 flex items-center justify-center">
                  <div class="text-center">
                      <i class="fa fa-circle-o-notch fa-spin text-primary text-3xl mb-2"></i>
                      <p class="text-dark-2">加载性能数据中...</p>
                  </div>
                  <canvas id="systemTrendChart" class="hidden"></canvas>
              </div>
          </div>
          
          <!-- 最近任务列表 -->
          <div class="bg-white rounded-xl p-6 card-shadow">
              <div class="flex justify-between items-center mb-6">
                  <h2 class="text-lg font-semibold text-dark">最近任务</h2>
                  <a href="nothing.html" class="text-primary text-sm hover:underline" title="跳转至任务列表页面">查看全部</a>
              </div>
              
              <div class="space-y-5" id="recentTasks">
                  <!-- 加载状态 -->
                  <div class="flex flex-col items-center justify-center py-10 text-dark-2">
                      <i class="fa fa-circle-o-notch fa-spin text-2xl mb-3"></i>
                      <p>加载任务数据中...</p>
                  </div>
              </div>
          </div>
      </div>
      
      <!-- 安全告警信息区 -->
      <section>
          <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-semibold text-dark">安全告警信息</h2>
              <div class="flex items-center">
                  <span class="text-sm text-dark-2 mr-2">共 <span class="text-danger font-medium" id="alertCount">0</span> 条告警</span>
                  <button class="text-primary text-sm hover:underline">清除全部</button>
              </div>
          </div>
          
          <div class="bg-white rounded-xl overflow-hidden card-shadow">
              <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-light-2">
                      <thead class="bg-light-1">
                          <tr>
                              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-dark-2 uppercase tracking-wider">告警类型</th>
                              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-dark-2 uppercase tracking-wider">详细信息</th>
                              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-dark-2 uppercase tracking-wider">发生时间</th>
                              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-dark-2 uppercase tracking-wider">状态</th>
                              <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-dark-2 uppercase tracking-wider">操作</th>
                          </tr>
                      </thead>
                      <tbody class="bg-white divide-y divide-light-2" id="alertTableBody">
                          <!-- 加载状态 -->
                          <tr>
                              <td colspan="5" class="px-6 py-10 text-center text-dark-2">
                                  <i class="fa fa-circle-o-notch fa-spin mr-2"></i>加载告警数据中...
                              </td>
                          </tr>
                      </tbody>
                  </table>
              </div>
              
              <!-- 分页控件已移除 -->
          </div>
      </section>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="bg-white border-t border-light-2 py-6">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="text-dark-2 text-sm mb-4 md:mb-0">
          © 2025 SecureDataFlow. 保留所有权利.
        </div>
        <div class="flex space-x-6">
          <a href="#" class="text-dark-2 hover:text-primary text-sm">回到主页 第319行</a><!-- 不要可删 ！-->
          <a href="#" class="text-dark-2 hover:text-primary text-sm">技术文档 第320行</a><!-- 不要可删 ！-->
          <a href="#" class="text-dark-2 hover:text-primary text-sm">联系我们 第321行</a><!-- 不要可删 ！-->
        </div>
      </div>
    </div>
  </footer>

  <!-- JavaScript -->
  <script>
    // 统一初始化函数 - 已修复重复定义问题
    function initializeDashboard() {
      console.log('Dashboard initialized at:', new Date().toISOString());
      
      // 初始化图表框架
      initChartFrames();
      
      // 绑定所有按钮事件（关键）
      bindButtonEvents();
      
      // 刷新按钮事件
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) {
        refreshBtn.removeEventListener('click', handleRefresh);
        
        function handleRefresh() {
          const icon = refreshBtn.querySelector('i');
          icon.classList.add('fa-spin');
          
          setTimeout(() => {
            icon.classList.remove('fa-spin');
            showNotification('仪表盘已更新', 'success');
          }, 800);
        }
        
        refreshBtn.addEventListener('click', handleRefresh);
      }
      
      // 监听滚动事件
      window.addEventListener('scroll', function() {
        const header = document.getElementById('header');
        if (window.scrollY > 10) {
          header.classList.add('shadow');
        } else {
          header.classList.remove('shadow');
        }
      });
      
      // 加载数据
      loadDashboardData();
    }

    // 事件监听
    document.addEventListener('DOMContentLoaded', initializeDashboard);
    window.addEventListener('pageshow', function() {
      initializeDashboard();
    });
    
    // 初始化图表框架（无数据）
    function initChartFrames() {
      // 初始化空图表框架
      const charts = ['tasksChart', 'nodesChart', 'trafficChart', 'latencyChart'];
      charts.forEach(chartId => {
        new Chart(document.getElementById(chartId), {
          type: 'line',
          data: {
            labels: Array(10).fill(''),
            datasets: [{
              data: Array(10).fill(null),
              borderColor: '#165DFF',
              backgroundColor: 'rgba(22, 93, 255, 0.1)',
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.4,
              fill: true
            }]
          },
          options: getSmallChartOptions()
        });
      });
      
      // ====== API调用预留位置 ======
      // 实际项目中应调用API加载图表数据
      // fetch('/api/dashboard/charts')
      //   .then(res => res.json())
      //   .then(data => updateChartsWithData(data));
    }
    
    // 小型图表配置选项
    function getSmallChartOptions() {
      return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        scales: { x: { display: false }, y: { display: false } },
        elements: { line: { tension: 0.4 } },
        animation: { duration: 0 }
      };
    }
    
    // 加载仪表盘数据
    async function loadDashboardData() {
      try {
        document.getElementById('lastUpdate').textContent = '加载中...';
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // ====== API调用预留位置 ======
        // 实际项目中应调用API加载真实数据
        // const statsData = await fetch('/api/dashboard/stats').then(res => res.json());
        // updateOverviewStats(statsData);
        
        document.getElementById('lastUpdate').textContent = '刚刚';
        
      } catch (error) {
        console.error('加载数据失败:', error);
        showNotification('数据加载失败', 'error');
      }
    }
    
    // 下拉菜单事件绑定
    function bindButtonEvents() {
      // 清除可能存在的旧事件监听器
      document.removeEventListener('click', handleDocumentClick);
      
      // 添加文档级事件委托（单一事件源）
      function handleDocumentClick(e) {
        const notificationBtn = document.getElementById('notificationBtn');
        const notificationDropdown = document.getElementById('notificationDropdown');
        const userMenu = document.getElementById('userMenuContainer');
        const userDropdown = document.getElementById('userDropdown');
        
        // 点击通知按钮
        if (notificationBtn && e.target.closest('#notificationBtn')) {
          e.stopPropagation();
          notificationDropdown.classList.toggle('hidden');
          if (userDropdown) userDropdown.classList.add('hidden');
        }
        // 点击用户区域
        else if (userMenu && e.target.closest('#userMenuContainer')) {
          e.stopPropagation();
          userDropdown.classList.toggle('hidden');
          if (notificationDropdown) notificationDropdown.classList.add('hidden');
        }
        // 点击其他区域关闭所有下拉菜单
        else {
          if (notificationDropdown) notificationDropdown.classList.add('hidden');
          if (userDropdown) userDropdown.classList.add('hidden');
        }
      }
      
      // 绑定文档点击事件
      document.addEventListener('click', handleDocumentClick);
      
      // 图表周期选择按钮
      const periodBtns = document.querySelectorAll('.period-btn');
      periodBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          periodBtns.forEach(b => {
            b.classList.remove('bg-primary/10', 'text-primary');
            b.classList.add('hover:bg-light-1', 'text-dark-2');
          });
          this.classList.remove('hover:bg-light-1', 'text-dark-2');
          this.classList.add('bg-primary/10', 'text-primary');
          showNotification(`已切换到${this.textContent}数据视图`, 'info');
        });
      });
      
      // 清除全部告警按钮
      const clearAllAlertsBtn = Array.from(document.querySelectorAll('button'))
        .find(btn => btn.textContent.trim() === '清除全部');
      if (clearAllAlertsBtn) {
        clearAllAlertsBtn.addEventListener('click', function() {
          if (confirm('确定要清除所有告警吗？')) {
            document.getElementById('alertCount').textContent = '0';
            document.getElementById('alertTableBody').innerHTML = `
              <tr><td colspan="5" class="px-6 py-10 text-center text-dark-2">暂无告警数据</td></tr>
            `;
            showNotification('所有告警已清除', 'success');
          }
        });
      }
    }
    
    // 显示通知提示
    function showNotification(message, type = 'info') {
      let color = {
        success: '#52C41A', error: '#FF4D4F', info: '#165DFF', warning: '#FAAD14'
      }[type] || '#165DFF';

      let notification = document.createElement('div');
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed; top: 24px; right: 24px; z-index: 9999;
        background: ${color}; color: #fff; padding: 12px 24px;
        border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        font-size: 16px; opacity: 0; transition: opacity 0.3s;
      `;

      document.body.appendChild(notification);
      setTimeout(() => notification.style.opacity = '1', 10);
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }
  </script>

</body>
</html>
