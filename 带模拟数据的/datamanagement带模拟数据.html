<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SecureDataFlow 数据管理</title>
  <!-- 引入外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            success: '#52C41A',
            dark: '#1D2129',
            'dark-2': '#4E5969',
            'light-1': '#F2F3F5',
            'light-2': '#E5E6EB'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>

  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-shadow {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }
      .gradient-bg {
        background: linear-gradient(135deg, #165DFF 0%, #0E42D2 100%);
      }
      .pulse-animation {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
      .tree-item {
        padding: 0.375rem 0.75rem; /* 增加右侧内边距 */
        margin: 0.25rem 0; /* 增大节点间距 */
        border-radius: 0.375rem; /* 优化圆角 */
        cursor: pointer; 
        display: flex; 
        align-items: center; 
        gap: 0.5rem; 
        transition: all 0.15s ease; /* 平滑过渡效果 */
      }
      .tree-item.active {
        /* 移除整行背景和左侧边框 */
        background-color: transparent; 
        color: inherit;
        border-left: none;
        padding-left: 0.75rem;
      }
      
      /* 新增文字高亮样式 */
      .tree-item.active .name-span {
        background-color: #e8f3ff;
        color: #165DFF;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-weight: 500;
      }
      
      .tree-children {
        padding-left: 1.75rem; /* 微调连接线位置 */
        margin-top: 0.25rem;
        margin-bottom: 0.25rem;
        border-left: 1px dashed #d9d9d9;
        margin-left: 0.75rem;
      }
      .tree-toggle {
        cursor: pointer;
        transition: transform 0.2s ease;
      }
      .tree-toggle.collapsed {
        transform: rotate(-90deg);
      }
      .tree-item:hover {
        background-color: #f2f3f5;
      }
      .permission-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
      }
    }
  </style>
</head>

<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-sm fixed w-full z-50 transition-all duration-300" id="header">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <!-- 左侧Logo和标题 -->
        <div class="flex items-center">
          <div class="flex-shrink-0 flex items-center">
            <div class="w-8 h-8 rounded-md gradient-bg flex items-center justify-center">
              <i class="fa fa-shield text-white"></i>
            </div>
            <span class="ml-2 text-lg font-semibold text-dark">SecureDataFlow 数据管理</span>
          </div>
        </div>

        <!-- 右侧工具栏 -->
        <div class="flex items-center space-x-4">
          <!-- 刷新按钮 -->
          <button class="p-2 rounded-full hover:bg-light-1 transition-colors" id="headerRefreshBtn">
            <i class="fa fa-refresh text-dark-2"></i>
          </button>

          <!-- 用户信息 -->
          <div class="flex items-center">
            <img class="h-8 w-8 rounded-full object-cover" src="https://picsum.photos/id/1005/200/200" alt="用户头像">
            <span class="ml-2 text-sm font-medium hidden md:block">管理员</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="flex-1 pt-20 pb-10 flex">
    <!-- 侧边栏 - 数据目录浏览器 -->
    <aside class="w-[410px] bg-white shadow-sm fixed h-[calc(100vh-5rem)] overflow-y-auto transition-all duration-300 z-40" id="sidebar">
      <!-- 添加拖动调节手柄 -->
      <div class="absolute top-0 right-0 w-1 h-full bg-gray-200 cursor-col-resize" id="sidebarResizer"></div>
      <div class="p-4 border-b border-light-2">
        <div class="relative">
          <input type="text" id="treeSearch" placeholder="搜索数据表..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-light-2 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary text-sm">
          <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-dark-2"></i>
        </div>
      </div>
      <div class="p-4" id="dataTree">
        <!-- 树状结构将通过JS动态生成 -->
        <div class="text-center text-dark-2 py-8">
          <i class="fa fa-folder-open-o text-2xl mb-2 block"></i>
          <p>加载数据表结构中...</p>
        </div>
      </div>
    </aside>

    <!-- 主内容区域 -->
    <div class="ml-[410px] flex-1 transition-all duration-300" id="mainContent">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- 页面标题和操作区 -->
        <div class="mb-6 flex flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-dark">数据管理模块</h1>
            <p class="text-dark-2 mt-1">统一展示与管理平台可访问的数据表结构、字段权限与访问记录</p>
          </div>
          <div class="flex gap-3">
            <div class="relative">
              <input type="text" id="globalSearch" placeholder="全局搜索字段或表名..." class="pl-10 pr-4 py-2 rounded-lg border border-light-2 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary text-sm w-full sm:w-64">
              <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-dark-2"></i>
            </div>
            <button id="contentRefreshBtn" class="p-2 rounded-lg border border-light-2 hover:bg-light-1 transition-colors">
              <i class="fa fa-refreshresh text-dark-2"></i>
            </button>
          </div>
        </div>

        <!-- 内容标签页 -->
        <div class="border-b border-light-2 mb-6">
          <ul class="flex flex-wrap -mb-px" id="contentTabs">
            <li class="mr-2"><button class="content-tab-btn active py-4 px-4 text-sm font-medium text-primary border-b-2 border-primary" data-tab="permission-matrix">权限矩阵管理</button></li>
            <li class="mr-2"><button class="content-tab-btn py-4 px-4 text-sm font-medium text-dark-2 border-b-2 border-transparent hover:text-dark hover:border-light-2" data-tab="access-audit">数据调取审计</button></li>
          </ul>
        </div>

        <!-- 权限矩阵管理 -->
        <div class="content-tab active" id="permission-matrix">
          <div class="bg-white rounded-xl p-6 card-shadow mb-6">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-lg font-semibold">权限矩阵</h2>
              <div class="text-sm text-dark-2">当前选中表: <span id="currentTableName" class="font-medium text-dark">未选择</span></div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-light-2" id="permissionMatrixTable">
                <thead class="bg-light-1">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-dark-2 uppercase tracking-wider">部门</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-dark-2 uppercase tracking-wider">查看权限</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-dark-2 uppercase tracking-wider">编辑权限</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-dark-2 uppercase tracking-wider">导出权限</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-dark-2 uppercase tracking-wider">管理权限</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-light-2" id="permissionMatrixBody">
                  <!-- 权限矩阵内容将通过JS动态生成 -->
                  <tr><td colspan="5" class="text-center py-10 text-dark-2">请从左侧选择数据表查看权限矩阵</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- 数据调取审计 -->
        <div class="content-tab hidden" id="access-audit">
          <div class="bg-white rounded-xl p-6 card-shadow">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-lg font-semibold">数据调取审计记录</h2>
              <div class="flex gap-2">
                <select id="auditFilterTable" class="text-sm border border-light-2 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary">
                  <option value="all">所有表</option>
                  <!-- 表选项将通过JS动态生成 -->
                </select>
                <select id="auditFilterUser" class="text-sm border border-light-2 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary">
                  <option value="all">所有用户</option>
                  <!-- 用户选项将通过JS动态生成 -->
                </select>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-light-2">
                <thead class="bg-light-1">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-dark-2 uppercase tracking-wider">用户</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-dark-2 uppercase tracking-wider">数据表</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-dark-2 uppercase tracking-wider">操作</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-dark-2 uppercase tracking-wider">时间</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-dark-2 uppercase tracking-wider">IP地址</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-light-2" id="auditLogBody">
                  <!-- 审计日志内容将通过JS动态生成 -->
                  <tr><td colspan="5" class="text-center py-10 text-dark-2">加载审计记录中...</td></tr>
                </tbody>
              </table>
            </div>
            <div class="flex justify-between items-center mt-4">
              <div class="text-sm text-dark-2">显示 1 至 10 条，共 <span id="totalAuditCount">0</span> 条记录</div>
              <div class="flex gap-1">
                <button class="px-3 py-1 text-sm border border-light-2 rounded hover:bg-light-1 disabled:opacity-50" id="prevPage" disabled>上一页</button>
                <button class="px-3 py-1 text-sm border border-light-2 rounded hover:bg-light-1" id="nextPage">下一页</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="bg-white border-t border-light-2 py-6">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="text-dark-2 text-sm mb-4 md:mb-0">
          © 2025 SecureDataFlow. 保留所有权利.
        </div>
        <div class="flex space-x-6">
          <a href="#" class="text-dark-2 hover:text-primary text-sm">回到主页</a>
          <a href="#" class="text-dark-2 hover:text-primary text-sm">技术文档</a>
          <a href="#" class="text-dark-2 hover:text-primary text-sm">联系我们</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- JavaScript -->
  <script>
    // 初始化函数
    function initializeDashboard() {
      // 滚动事件监听（头部阴影效果）
      window.addEventListener('scroll', function () {
        const header = document.getElementById('header');
        if (window.scrollY > 10) {
          header.classList.add('shadow');
        } else {
          header.classList.remove('shadow');
        }
      });
    }

    // DOM加载完成后初始化
    document.addEventListener('DOMContentLoaded', initializeDashboard);

    // 刷新按钮功能
    const headerRefreshBtn = document.getElementById('headerRefreshBtn');
    if (headerRefreshBtn) {
      headerRefreshBtn.addEventListener('click', function() {
        const icon = headerRefreshBtn.querySelector('i');
        icon.classList.add('fa-spin');

        setTimeout(() => {
          icon.classList.remove('fa-spin');
          // 刷新数据
          initDataManagementModule();
        }, 800);
      });
    }

    const contentRefreshBtn = document.getElementById('contentRefreshBtn');
    if (contentRefreshBtn) {
      contentRefreshBtn.addEventListener('click', function() {
        const icon = contentRefreshBtn.querySelector('i');
        icon.classList.add('fa-spin');

        setTimeout(() => {
          icon.classList.remove('fa-spin');
          // 刷新数据
          initDataManagementModule();
        }, 800);
      });
    }
  </script>

  <script>
    // 数据管理模块实现
    document.addEventListener('DOMContentLoaded', function() {
      // 模拟数据 - Hive表结构
      const hiveTables = [
        {
          id: 'db1',
          name: 'user_db',
          type: 'database',
          children: [
            {
              id: 'tbl1',
              name: 'user_info',
              type: 'table',
              description: '用户基本信息表',
              fields: [
                { name: 'user_id', type: 'int', sensitive: 'high', comment: '用户ID' },
                { name: 'username', type: 'string', sensitive: 'medium', comment: '用户名' },
                { name: 'email', type: 'string', sensitive: 'high', comment: '电子邮箱' },
                { name: 'register_time', type: 'timestamp', sensitive: 'low', comment: '注册时间' },
                { name: 'last_login', type: 'timestamp', sensitive: 'low', comment: '最后登录时间' }
              ]
            },
            {
              id: 'tbl2',
              name: 'user_behavior',
              type: 'table',
              description: '用户行为记录表',
              fields: [
                { name: 'behavior_id', type: 'int', sensitive: 'low', comment: '行为ID' },
                { name: 'user_id', type: 'int', sensitive: 'high', comment: '用户ID' },
                { name: 'action_type', type: 'string', sensitive: 'low', comment: '操作类型' },
                { name: 'action_time', type: 'timestamp', sensitive: 'low', comment: '操作时间' },
                { name: 'ip_address', type: 'string', sensitive: 'medium', comment: 'IP地址' }
              ]
            }
          ]
        },
        {
          id: 'db2',
          name: 'order_db',
          type: 'database',
          children: [
            {
              id: 'tbl3',
              name: 'order_info',
              type: 'table',
              description: '订单信息表',
              fields: [
                { name: 'order_id', type: 'string', sensitive: 'high', comment: '订单ID' },
                { name: 'user_id', type: 'int', sensitive: 'high', comment: '用户ID' },
                { name: 'product_id', type: 'int', sensitive: 'low', comment: '产品ID' },
                { name: 'amount', type: 'decimal', sensitive: 'medium', comment: '订单金额' },
                { name: 'order_time', type: 'timestamp', sensitive: 'low', comment: '下单时间' },
                { name: 'status', type: 'string', sensitive: 'low', comment: '订单状态' }
              ]
            }
          ]
        }
      ];

      // 模拟数据 - 权限矩阵
      const permissionMatrix = {
        'tbl1': [
          { department: '技术部', view: true, edit: true, export: true, manage: true },
          { department: '产品部', view: true, edit: false, export: true, manage: false },
          { department: '运营部', view: true, edit: false, export: true, manage: false },
          { department: '财务部', view: false, edit: false, export: false, manage: false },
          { department: '人力资源部', view: false, edit: false, export: false, manage: false }
        ],
        'tbl2': [
          { department: '技术部', view: true, edit: true, export: true, manage: true },
          { department: '产品部', view: true, edit: true, export: true, manage: false },
          { department: '运营部', view: true, edit: true, export: true, manage: false },
          { department: '财务部', view: false, edit: false, export: false, manage: false },
          { department: '人力资源部', view: false, edit: false, export: false, manage: false }
        ],
        'tbl3': [
          { department: '技术部', view: true, edit: true, export: true, manage: true },
          { department: '产品部', view: true, edit: false, export: false, manage: false },
          { department: '运营部', view: true, edit: false, export: true, manage: false },
          { department: '财务部', view: true, edit: true, export: true, manage: false },
          { department: '人力资源部', view: false, edit: false, export: false, manage: false }
        ]
      };

      // 模拟数据 - 审计日志
      const auditLogs = [
        { id: 1, user: '张三', tableId: 'tbl1', tableName: 'user_info', action: '查询', time: '2023-06-15 09:23:45', ip: '192.168.1.101' },
        { id: 2, user: '李四', tableId: 'tbl3', tableName: 'order_info', action: '导出', time: '2023-06-15 10:12:33', ip: '192.168.1.102' },
        { id: 3, user: '王五', tableId: 'tbl2', tableName: 'user_behavior', action: '查询', time: '2023-06-15 11:05:17', ip: '192.168.1.103' },
        { id: 4, user: '赵六', tableId: 'tbl1', tableName: 'user_info', action: '查询', time: '2023-06-15 13:42:08', ip: '192.168.1.104' },
        { id: 5, user: '钱七', tableId: 'tbl3', tableName: 'order_info', action: '查询', time: '2023-06-15 14:22:51', ip: '192.168.1.105' },
        { id: 6, user: '张三', tableId: 'tbl2', tableName: 'user_behavior', action: '导出', time: '2023-06-15 15:10:33', ip: '192.168.1.101' },
        { id: 7, user: '李四', tableId: 'tbl1', tableName: 'user_info', action: '查询', time: '2023-06-15 16:05:47', ip: '192.168.1.102' },
        { id: 8, user: '王五', tableId: 'tbl3', tableName: 'order_info', action: '查询', time: '2023-06-15 17:30:22', ip: '192.168.1.103' },
        { id: 9, user: '赵六', tableId: 'tbl3', tableName: 'order_info', action: '导出', time: '2023-06-15 18:45:11', ip: '192.168.1.104' },
        { id: 10, user: '钱七', tableId: 'tbl2', tableName: 'user_behavior', action: '查询', time: '2023-06-15 19:12:36', ip: '192.168.1.105' }
      ];

      // 全局变量
      let currentSelectedTable = null;
      let filteredAuditLogs = [...auditLogs];
      let currentAuditPage = 1;
      const auditPageSize = 5;

      // 渲染Hive表结构树
      function renderTree(data, container) {
        const treeContainer = document.getElementById(container);
        treeContainer.innerHTML = '';

        function buildTreeNodes(nodes, parentElement) {
          nodes.forEach(node => {
            const nodeElement = document.createElement('div');
            nodeElement.className = 'tree-item';
            nodeElement.dataset.id = node.id;
            nodeElement.dataset.type = node.type;
            
            // 添加折叠按钮
            if (node.children && node.children.length > 0) {
              const toggleBtn = document.createElement('i');
              toggleBtn.className = 'fa fa-chevron-down tree-toggle';
              toggleBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const childrenContainer = nodeElement.querySelector('.tree-children');
                childrenContainer.classList.toggle('hidden');
                toggleBtn.classList.toggle('collapsed');
              });
              nodeElement.appendChild(toggleBtn);
            } else {
              // 添加占位图标保持对齐
              const spacer = document.createElement('i');
              spacer.className = 'fa fa-fw';
              nodeElement.appendChild(spacer);
            }

            const icon = document.createElement('i');
            icon.className = 'fa ' + (node.type === 'database' ? 'fa-database tree-item-icon' : 'fa-table tree-item-icon');
            nodeElement.appendChild(icon);

            const nameSpan = document.createElement('span');
            nameSpan.className = 'name-span'; /* 添加类名 */
            nameSpan.textContent = node.name;
            nodeElement.appendChild(nameSpan);

            if (node.type === 'table' && node.description) {
              nodeElement.title = node.description;
            }

            // 点击事件 - 选择表
            nodeElement.addEventListener('click', function(e) {
              e.stopPropagation();
              // 移除其他选中状态
              document.querySelectorAll('.tree-item.active').forEach(el => el.classList.remove('active'));
              // 设置当前选中状态
              nodeElement.classList.add('active');
              currentSelectedTable = node;
              document.getElementById('currentTableName').textContent = node.name;
              renderPermissionMatrix(node.id);
            });

            parentElement.appendChild(nodeElement);

            // 如果有子节点，渲染子节点
            if (node.children && node.children.length > 0) {
              const childrenContainer = document.createElement('div');
              childrenContainer.className = 'tree-children';
              nodeElement.appendChild(childrenContainer);
              buildTreeNodes(node.children, childrenContainer);
            }
          });
        }

        buildTreeNodes(data, treeContainer);
      }

      // 渲染权限矩阵
      function renderPermissionMatrix(tableId) {
        const matrixData = permissionMatrix[tableId] || [];
        const matrixBody = document.getElementById('permissionMatrixBody');

        if (matrixData.length === 0) {
          matrixBody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-dark-2">暂无该表的权限数据</td></tr>';
          return;
        }

        matrixBody.innerHTML = '';
        matrixData.forEach(item => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-light-1 transition-colors';          
          row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-dark">${item.department}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="permission-badge ${item.view ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-500'}">
                ${item.view ? '允许' : '禁止'}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="permission-badge ${item.edit ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-500'}">
                ${item.edit ? '允许' : '禁止'}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="permission-badge ${item.export ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-500'}">
                ${item.export ? '允许' : '禁止'}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="permission-badge ${item.manage ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-500'}">
                ${item.manage ? '允许' : '禁止'}
              </span>
            </td>
          `;
          matrixBody.appendChild(row);
        });
      }

      // 渲染审计日志
      function renderAuditLogs(page = 1) {
        const startIndex = (page - 1) * auditPageSize;
        const endIndex = startIndex + auditPageSize;
        const paginatedLogs = filteredAuditLogs.slice(startIndex, endIndex);
        const auditBody = document.getElementById('auditLogBody');
        const totalCountEl = document.getElementById('totalAuditCount');
        const prevBtn = document.getElementById('prevPage');
        const nextBtn = document.getElementById('nextPage');

        totalCountEl.textContent = filteredAuditLogs.length;

        if (paginatedLogs.length === 0) {
          auditBody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-dark-2">暂无审计记录</td></tr>';
        } else {
          auditBody.innerHTML = '';
          paginatedLogs.forEach(log => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-light-1 transition-colors';
            row.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap text-sm text-dark">${log.user}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-dark">${log.tableName}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <span class="permission-badge ${log.action === '导出' ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800'}">
                  ${log.action}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-2">${log.time}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-dark-2">${log.ip}</td>
            `;
            auditBody.appendChild(row);
          });
        }

        // 分页按钮状态
        prevBtn.disabled = page === 1;
        nextBtn.disabled = endIndex >= filteredAuditLogs.length;
        currentAuditPage = page;
      }

      // 初始化审计日志筛选器
      function initAuditFilters() {
        const tableFilter = document.getElementById('auditFilterTable');
        const userFilter = document.getElementById('auditFilterUser');

        // 获取所有唯一表名
        const tables = [...new Set(auditLogs.map(log => log.tableName))];
        tables.forEach(table => {
          const option = document.createElement('option');
          option.value = table;
          option.textContent = table;
          tableFilter.appendChild(option);
        });

        // 获取所有唯一用户名
        const users = [...new Set(auditLogs.map(log => log.user))];
        users.forEach(user => {
          const option = document.createElement('option');
          option.value = user;
          option.textContent = user;
          userFilter.appendChild(option);
        });

        // 筛选事件
        tableFilter.addEventListener('change', applyAuditFilters);
        userFilter.addEventListener('change', applyAuditFilters);
      }

      // 应用审计日志筛选
      function applyAuditFilters() {
        const tableFilter = document.getElementById('auditFilterTable').value;
        const userFilter = document.getElementById('auditFilterUser').value;

        filteredAuditLogs = auditLogs.filter(log => {
          const tableMatch = tableFilter === 'all' || log.tableName === tableFilter;
          const userMatch = userFilter === 'all' || log.user === userFilter;
          return tableMatch && userMatch;
        });

        renderAuditLogs(1); // 重置到第一页
      }

      // 全局搜索功能
      function initGlobalSearch() {
        const searchInput = document.getElementById('globalSearch');
        searchInput.addEventListener('input', function(e) {
          const searchTerm = e.target.value.toLowerCase().trim();
          if (searchTerm === '') {
            // 重置树状结构
            renderTree(hiveTables, 'dataTree');
            return;
          }

          // 简单的模糊搜索实现
          function searchInNodes(nodes, term) {
            return nodes.filter(node => {
              if (node.name.toLowerCase().includes(term)) return true;
              if (node.fields) {
                for (let field of node.fields) {
                  if (field.name.toLowerCase().includes(term) ||
                      (field.comment && field.comment.toLowerCase().includes(term))) {
                    return true;
                  }
                }
              }
              if (node.children) {
                node.children = searchInNodes(node.children, term);
                return node.children.length > 0;
              }
              return false;
            });
          }

          const filteredNodes = searchInNodes([...hiveTables], searchTerm);
          renderTree(filteredNodes, 'dataTree');
        });
      }

      // 初始化标签页切换
      function initTabs() {
        const tabButtons = document.querySelectorAll('.content-tab-btn');
        const tabs = document.querySelectorAll('.content-tab');

        tabButtons.forEach(button => {
          button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');

            // 更新按钮状态
            tabButtons.forEach(btn => {
              btn.classList.remove('active', 'text-primary', 'border-primary');
              btn.classList.add('text-dark-2', 'border-transparent');
            });
            this.classList.add('active', 'text-primary', 'border-primary');
            this.classList.remove('text-dark-2', 'border-transparent');

            // 更新内容区域
            tabs.forEach(tab => {
              tab.classList.add('hidden');
              tab.classList.remove('active');
            });

            const activeTab = document.getElementById(tabId);
            activeTab.classList.remove('hidden');
            activeTab.classList.add('active');
          });
        });
      }

      // 初始化树搜索功能
      function initTreeSearch() {
        const searchInput = document.getElementById('treeSearch');
        searchInput.addEventListener('input', function(e) {
          const searchTerm = e.target.value.toLowerCase().trim();
          if (searchTerm === '') {
            renderTree(hiveTables, 'dataTree');
            return;
          }

          // 搜索数据表和数据库
          function searchTreeNodes(nodes, term) {
            return nodes.filter(node => {
              if (node.name.toLowerCase().includes(term)) return true;
              if (node.children) {
                node.children = searchTreeNodes(node.children, term);
                return node.children.length > 0;
              }
              return false;
            });
          }

          const filteredNodes = searchTreeNodes([...hiveTables], searchTerm);
          renderTree(filteredNodes, 'dataTree');
        });
      }

      // 初始化数据管理模块
      function initDataManagementModule() {
        // 渲染Hive表结构树
        renderTree(hiveTables, 'dataTree');

        // 初始化权限矩阵
        renderPermissionMatrix('');

        // 初始化审计日志
        initAuditFilters();
        renderAuditLogs();

        // 初始化全局搜索
        initGlobalSearch();
        
        // 初始化树搜索
        initTreeSearch();

        // 初始化标签页
        initTabs();

        // 上一页/下一页事件
        document.getElementById('prevPage').addEventListener('click', function() {
          if (currentAuditPage > 1) {
            renderAuditLogs(currentAuditPage - 1);
          }
        });

        document.getElementById('nextPage').addEventListener('click', function() {
          const maxPage = Math.ceil(filteredAuditLogs.length / auditPageSize);
          if (currentAuditPage < maxPage) {
            renderAuditLogs(currentAuditPage + 1);
          }
        });
      }

      // 启动数据管理模块
      initDataManagementModule();
    });
  </script>
</body>
</html>

<script>
// 添加侧边栏大小调节功能
const sidebar = document.getElementById('sidebar');
const mainContent = document.getElementById('mainContent');
const resizer = document.getElementById('sidebarResizer');
let isResizing = false;

resizer.addEventListener('mousedown', (e) => {
  isResizing = true;
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';
});

document.addEventListener('mousemove', (e) => {
  if (!isResizing) return;

  // 限制最小宽度400px，最大宽度550px
  const newWidth = Math.max(400, Math.min(550, e.clientX));
  sidebar.style.width = `${newWidth}px`;
  mainContent.style.marginLeft = `${newWidth}px`;
});

document.addEventListener('mouseup', () => {
  if (isResizing) {
    isResizing = false;
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
  }
});
</script>
</body>
</html>